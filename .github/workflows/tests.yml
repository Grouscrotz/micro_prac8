name: CI/CD pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest alembic psycopg2-binary || true

      # ---------- UNIT TESTS ----------
      - name: Run unit tests
        run: |
          echo "=== Running unit tests ==="
          if [ -d "./tests/unit" ]; then
            pytest ./tests/unit -v --maxfail=1 --disable-warnings
          else
            echo "⚠️  No unit tests found in ./tests/unit — skipping"
          fi

      # ---------- INTEGRATION TESTS ----------
      - name: Prepare PostgreSQL for integration tests
        run: |
          echo "=== Starting PostgreSQL container for integration tests ==="
          docker run -e POSTGRES_PASSWORD=testpass \
                     -e POSTGRES_USER=testuser \
                     -e POSTGRES_DB=test_pharmacy_db \
                     -p 5433:5432 -d postgres:14
          sleep 10  # ждём пока БД поднимется

          echo "TEST_DB_URL=postgresql://testuser:testpass@localhost:5433/test_pharmacy_db" > .env
          echo "✅ Database ready and .env created"

      - name: Run integration tests
        run: |
          echo "=== Running integration tests ==="
          if [ -d "./tests/integration" ]; then
            alembic upgrade head || echo "⚠️ Alembic not configured, skipping migrations"
            pytest ./tests/integration -v --maxfail=1 --disable-warnings
          else
            echo "⚠️  No integration tests found in ./tests/integration — skipping"
          fi
        env:
          TEST_DB_URL: postgresql://testuser:testpass@localhost:5433/test_pharmacy_db

  # ---------- BUILD & DEPLOY ----------
  build-and-push-to-yc:
    name: Build and push to Yandex Cloud Registry
    runs-on: ubuntu-latest
    needs: test
    if: success()  # выполняется только если тесты прошли

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          echo "=== Building Docker image ==="
          docker build -t cr.yandex/ycr_your-registry/users-service:${{ github.sha }} .

      - name: Push to Yandex Cloud
        run: |
          echo "=== Pushing image to Yandex Cloud Registry ==="
          # Пример — подставь свой токен и путь
          echo "✅ Image pushed successfully (simulated)"
