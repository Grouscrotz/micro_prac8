name: CI/CD pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Unit-тесты (без БД, как в методичке)
      - name: Prepare unit tests
        run: |
          sudo apt update
          sudo apt install -y python3-pip
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          pytest ./tests/unit -v

      # Интеграционные тесты (с БД, как в методичке)
      - name: Prepare integration tests
        run: |
          # Запускаем тестовый PostgreSQL (твоя TEST_DB_URL)
          sudo docker run -e POSTGRES_PASSWORD=testpass \
                          -e POSTGRES_USER=testuser \
                          -e POSTGRES_DB=test_pharmacy_db \
                          -p 5433:5432 -d postgres:14
          sleep 10  # Ждём запуска БД
          
          # Создаём .env для тестов (если нужно для database.py)
          rm ./.env || true
          echo "TEST_DB_URL=postgresql://testuser:testpass@localhost:5433/test_pharmacy_db" > .env
          
          # Миграция БД (alembic)
          alembic upgrade head
        env:
          POSTGRES_URL: postgresql://testuser:testpass@localhost:5433/test_pharmacy_db

      - name: Run integration tests
        run: |
          pytest ./tests/integration -v
        env:
          TEST_DB_URL: postgresql://testuser:testpass@localhost:5433/test_pharmacy_db

  # Job для билда и деплоя (как в методичке, но после тестов)
  build-and-push-to-yc:
    name: Build and push to YandexCloud Registry
    runs-on: ubuntu-latest
    needs: test  # Запускается ТОЛЬКО после успешных тестов!
    steps:
      - uses: actions/checkout@v3

      # ... (твои шаги для Docker build, push в Yandex Cloud Registry)
      # Пример: docker build -t your-image . && docker push ...
      - name: Build Docker image
        run: |
          docker build -t cr.yandex/ycr_your-registry/users-service:${{ github.sha }} .
      
      - name: Push to Yandex Cloud
        run: |
          # Авторизация и push (используй secrets из GitHub)
          echo ${{ secrets.YC_TOKEN }} | docker login --username json_key --password-stdin cr.yandex
          docker push cr.yandex/ycr_your-registry/users-service:${{ github.sha }}